<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>fritz-kola | THE WACH</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Anton&family=Inter:wght@400;600&display=swap');

        :root {
            --bg: #050505;
            --white: #f1f1f1;
            --red: #c91a1a; /* Original */
            --green: #4da850; /* Sugarfree */
            --purple: #6a3d98; /* Mischmasch */
            --orange: #f58220; /* Orange */
            --font-head: 'Anton', sans-serif;
            --font-body: 'Inter', sans-serif;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; user-select: none; }

        body {
            margin: 0; padding: 0;
            background-color: var(--bg);
            color: var(--white);
            font-family: var(--font-body);
            overflow: hidden;
            height: 100vh; width: 100vw;
            display: flex; flex-direction: column;
        }

        /* --- STYLED NOISE (Film Grain) --- */
        .noise {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: url('data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI1MTIiIGhlaWdodD0iNTEyIj48ZmlsdGVyIGlkPSJnoiPjxmZVR1cmJ1bGVuY2UgdHlwZT0iZnJhY3RhbE5vaXNlIiBiYXNlRnJlcXVlbmN5PSIwLjY1IiBudW1PY3RhdmVzPSIzIiBzdGl0Y2hUaWxlcz0ic3RpdGNoIi8+PC9maWx0ZXI+PHJlY3Qgd2lkdGg9IjEwMCUiIGhlaWdodD0iMTAwJSIgZmlsdGVyPSJ1cmwoI24pIiBvcGFjaXR5PSIwLjA1Ii8+PC9zdmc+');
            pointer-events: none; z-index: 50; opacity: 0.3;
        }

        /* --- HEADER --- */
        header {
            position: absolute; top: 0; left: 0; width: 100%;
            display: flex; justify-content: space-between; align-items: center;
            padding: 20px 24px; z-index: 40; transition: opacity 0.3s;
        }
        header.fade-out { opacity: 0; pointer-events: none; }
        
        .logo { font-family: var(--font-head); font-size: 1.8rem; text-transform: uppercase; letter-spacing: 1px; }
        .red { color: var(--red); }
        
        .badge {
            font-family: var(--font-head); font-size: 1rem;
            border: 1px solid rgba(255,255,255,0.4); padding: 6px 12px;
            text-transform: uppercase; background: rgba(0,0,0,0.8);
            display: flex; align-items: center; gap: 8px;
        }
        /* The "Two Faces" Logo Icon */
        .faces-icon {
            display: flex; gap: 2px;
        }
        .face { width: 8px; height: 10px; background: #fff; border-radius: 2px 2px 0 0; }

        /* --- CANVAS --- */
        #game-wrap { position: relative; width: 100%; height: 100%; background: #111; z-index: 1; }
        canvas { display: block; width: 100%; height: 100%; }

        /* --- SCREENS --- */
        .screen {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(5,5,5,0.98);
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            text-align: center; padding: 30px;
            opacity: 0; pointer-events: none; transition: opacity 0.3s;
            z-index: 100;
        }
        .screen.active { opacity: 1; pointer-events: auto; }

        h1 { font-family: var(--font-head); font-size: 3.5rem; margin: 0; line-height: 0.9; text-transform: uppercase; }
        p { color: #aaa; margin: 10px 0 30px 0; max-width: 300px; line-height: 1.4; }

        /* --- VAULT UI (Improved) --- */
        .vault-grid {
            display: grid; grid-template-columns: repeat(4, 1fr); gap: 12px;
            margin-bottom: 30px; width: 100%; max-width: 340px;
        }
        .cap-slot {
            display: flex; flex-direction: column; align-items: center; opacity: 0.3; transition: all 0.5s;
        }
        .cap-slot.unlocked { opacity: 1; transform: scale(1.1); filter: drop-shadow(0 0 8px rgba(255,255,255,0.2)); }
        
        .cap-circle {
            width: 50px; height: 50px; border-radius: 50%;
            border: 3px solid #222; margin-bottom: 8px; position: relative;
            display: flex; justify-content: center; align-items: center;
            font-family: var(--font-head); font-size: 0.8rem; color: #000;
            box-shadow: inset 0 0 10px rgba(0,0,0,0.5);
        }
        
        /* BRAND COLORS */
        .c-org { background: #fff; color: #000; } 
        .c-sugar { background: #4da850; color: #fff; }
        .c-misch { background: #6a3d98; color: #fff; } /* Purple */
        .c-orange { background: #f58220; color: #fff; }

        .cap-label { font-size: 0.6rem; text-transform: uppercase; letter-spacing: 1px; color: #888; }
        
        /* Highlight the ACTIVE bottle (The one you are playing as) */
        .cap-slot.active-skin .cap-circle { border-color: #fff; box-shadow: 0 0 15px rgba(255,255,255,0.8); }
        .cap-slot.active-skin .cap-label { color: #fff; text-decoration: underline; }

        /* --- BUTTONS --- */
        .btn {
            background: var(--white); color: var(--bg);
            font-family: var(--font-head); font-size: 1.2rem;
            padding: 18px 0; width: 100%; max-width: 260px;
            border: none; cursor: pointer; text-transform: uppercase; letter-spacing: 1px;
            margin-bottom: 12px;
            clip-path: polygon(10px 0, 100% 0, 100% calc(100% - 10px), calc(100% - 10px) 100%, 0 100%, 0 10px);
            transition: transform 0.1s;
        }
        .btn:active { transform: scale(0.98); background: #ccc; }
        .btn-outline { background: transparent; color: var(--white); border: 2px solid rgba(255,255,255,0.3); }
        .hidden { display: none !important; }

        /* --- MODAL --- */
        #modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.9); z-index: 9999;
            display: flex; justify-content: center; align-items: center;
            opacity: 0; pointer-events: none; transition: opacity 0.3s;
        }
        #modal-overlay.open { opacity: 1; pointer-events: auto; }
        .modal-box {
            background: #fff; color: #000; width: 85%; max-width: 340px; padding: 30px 20px; text-align: center;
            clip-path: polygon(15px 0, 100% 0, 100% calc(100% - 15px), calc(100% - 15px) 100%, 0 100%, 0 15px);
            transform: scale(0.9); transition: transform 0.3s;
        }
        #modal-overlay.open .modal-box { transform: scale(1); }
        .modal-title { font-family: var(--font-head); font-size: 1.8rem; margin-bottom: 10px; text-transform: uppercase; line-height: 1; }
        .modal-msg { font-size: 0.9rem; margin-bottom: 20px; font-family: var(--font-body); color: #333; line-height: 1.4; }
        .modal-btn { background: #000; color: #fff; border: none; padding: 12px 30px; font-family: var(--font-head); font-size: 1rem; cursor: pointer; }

        /* --- WARMUP --- */
        #warmup-overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            pointer-events: none; z-index: 80; opacity: 0; transition: opacity 0.2s;
        }
        #warmup-overlay.show { opacity: 1; }
        .control-icon { width: 80px; height: 80px; border: 3px solid #fff; border-radius: 10px; display: flex; justify-content: center; align-items: center; margin-bottom: 20px; background: rgba(0,0,0,0.5); }
        .key-anim { width: 60%; height: 20px; border: 2px solid #fff; animation: keyPress 0.6s infinite alternate; }
        @keyframes keyPress { from { transform: scale(1); background: transparent; } to { transform: scale(0.9); background: #fff; } }
        .tap-anim { width: 40px; height: 40px; border-radius: 50%; border: 3px solid #fff; animation: tapPulse 0.8s infinite; }
        @keyframes tapPulse { 0% { transform: scale(1); opacity: 1; border-width: 3px; } 100% { transform: scale(2); opacity: 0; border-width: 0px; } }
        .control-text { font-family: var(--font-head); font-size: 1.5rem; letter-spacing: 2px; text-transform: uppercase; }

        /* --- SCANNER --- */
        #s-cam { background: #000; padding: 0; }
        .camera-container { position: absolute; top: 0; left: 0; width: 100%; height: 100%; overflow: hidden; }
        video { width: 100%; height: 100%; object-fit: cover; }
        .scan-mask {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            width: 260px; height: 260px;
            box-shadow: 0 0 0 100vmax rgba(0, 0, 0, 0.85); 
            border: 2px solid rgba(255, 255, 255, 0.8); z-index: 10;
        }
        .laser { position: absolute; width: 100%; height: 2px; background: var(--red); box-shadow: 0 0 10px var(--red); animation: laser 1.8s infinite ease-in-out; top: 10%; }
        @keyframes laser { 0%{top:0; opacity:0;} 50%{opacity:1;} 100%{top:100%; opacity:0;} }
        .scan-msg { position: absolute; top: -40px; width: 100%; text-align: center; color: var(--white); font-family: var(--font-head); letter-spacing: 1px; }
        #btn-close-cam { position: absolute; top: 40px; right: 20px; width: auto; padding: 10px 20px; z-index: 200; background: rgba(0,0,0,0.5); border: 1px solid #fff; }
        #dev-tap { position: absolute; bottom: 0; left: 0; width: 100%; height: 80px; z-index: 999; }
        input[type="email"] { background: transparent; border: none; border-bottom: 2px solid var(--white); color: var(--white); font-family: monospace; font-size: 1.2rem; padding: 10px; width: 100%; max-width: 260px; text-align: center; margin-bottom: 20px; border-radius: 0; }
    </style>
</head>
<body>

    <div id="modal-overlay">
        <div class="modal-box">
            <div class="modal-title" id="m-title">ALERT</div>
            <div class="modal-msg" id="m-msg">...</div>
            <button class="modal-btn" onclick="closeModal()">OK</button>
        </div>
    </div>

    <div class="noise"></div>

    <header id="main-header">
        <div class="logo">fritz<span class="red">-</span>kola</div>
        <div class="badge">
            <div class="faces-icon"><div class="face"></div><div class="face"></div></div>
            <span id="ui-lives">0</span>
        </div>
    </header>

    <div id="game-wrap">
        <canvas id="c"></canvas>
        
        <div id="warmup-overlay">
            <div class="control-icon" id="hint-icon"></div>
            <div class="control-text" id="hint-text">TAP TO JUMP</div>
        </div>

        <div id="s-intro" class="screen active">
            <h1>The Vault</h1>
            <p id="intro-msg">Collect caps. The last bottle you scan becomes your player skin.</p>
            
            <div class="vault-grid">
                <div class="cap-slot" id="cap-orig"><div class="cap-circle c-org">FK</div><div class="cap-label">Orig</div></div>
                <div class="cap-slot" id="cap-sugar"><div class="cap-circle c-sugar">SF</div><div class="cap-label">Sugar</div></div>
                <div class="cap-slot" id="cap-misch"><div class="cap-circle c-misch">MM</div><div class="cap-label">Misch</div></div>
                <div class="cap-slot" id="cap-orange"><div class="cap-circle c-orange">OR</div><div class="cap-label">Orang</div></div>
            </div>

            <button class="btn" id="btn-scan">Scan Bottle</button>
            <button class="btn btn-outline hidden" id="btn-play">Start Run</button>
        </div>

        <div id="s-cam" class="screen">
            <div class="camera-container">
                <video id="video" playsinline autoplay muted></video>
                <div class="scan-mask">
                    <div class="scan-msg">ALIGN QR CODE</div>
                    <div class="laser"></div>
                </div>
            </div>
            <div id="dev-tap"></div> 
            <button class="btn btn-outline" id="btn-close-cam">CLOSE</button>
        </div>

        <div id="s-over" class="screen">
            <h1 id="go-title">ASLEEP</h1>
            <p id="go-msg">Score: 0</p>
            <div id="box-email" class="hidden">
                <input type="email" id="inp-email" placeholder="ENTER EMAIL">
                <button class="btn" id="btn-claim">Save Ticket</button>
            </div>
            <div id="box-actions">
                <button class="btn" id="btn-retry">Try Again</button>
                <button class="btn btn-outline" id="btn-rescan">Scan More</button>
            </div>
        </div>
    </div>

    <script>
        /**
         * FRITZ-KOLA "THE WACH" CAMPAIGN
         * Features: Dynamic Skins, Hamburg Skyline, Collection System
         */

        const CFG = { gravity: 0.45, jumpForce: -11.5, groundH: 80, speed: 5.0, target: 5 };

        // --- BOTTLE PALETTES (Visuals based on scan) ---
        const PALETTES = {
            'orig':   { body: '#eee', label: '#c91a1a', cap: '#ccc' }, // Classic
            'sugar':  { body: '#eee', label: '#4da850', cap: '#fff' }, // Green
            'misch':  { body: '#eee', label: '#6a3d98', cap: '#f58220' }, // Mischmasch (Purple/Orange)
            'orange': { body: '#eee', label: '#f58220', cap: '#f58220' }  // Orange
        };

        const db = {
            usedIds: JSON.parse(localStorage.getItem('fk_used_ids')) || [],
            redeemCode: function(qrId) {
                if (this.usedIds.includes(qrId)) return { success: false };
                this.usedIds.push(qrId);
                localStorage.setItem('fk_used_ids', JSON.stringify(this.usedIds));
                return { success: true };
            }
        };

        const state = {
            lives: parseInt(localStorage.getItem('fk_lives')) || 0,
            email: localStorage.getItem('fk_email') || null,
            collection: JSON.parse(localStorage.getItem('fk_coll')) || { orig:false, sugar:false, misch:false, orange:false },
            currentFlavor: localStorage.getItem('fk_flavor') || 'orig', // Default to Original
            isPlaying: false,
            score: 0,
            screen: 'intro',
            startTime: 0
        };

        const cvs = document.getElementById('c');
        const ctx = cvs.getContext('2d', { alpha: false });
        let W, H, scale, animId;

        function saveUserState() { 
            localStorage.setItem('fk_lives', state.lives); 
            if(state.email) localStorage.setItem('fk_email', state.email);
            localStorage.setItem('fk_coll', JSON.stringify(state.collection));
            localStorage.setItem('fk_flavor', state.currentFlavor);
        }

        function updateVault() {
            // Unlock visual slots
            if(state.collection.orig) document.getElementById('cap-orig').classList.add('unlocked');
            if(state.collection.sugar) document.getElementById('cap-sugar').classList.add('unlocked');
            if(state.collection.misch) document.getElementById('cap-misch').classList.add('unlocked');
            if(state.collection.orange) document.getElementById('cap-orange').classList.add('unlocked');

            // Highlight Active Skin
            document.querySelectorAll('.cap-slot').forEach(el => el.classList.remove('active-skin'));
            const activeId = 'cap-' + state.currentFlavor;
            const activeEl = document.getElementById(activeId);
            if(activeEl) activeEl.classList.add('active-skin');
        }

        // --- RESIZE & PLAYER ---
        const player = {
            x: 0, y: 0, w: 34, h: 74, vy: 0, grounded: false,
            update: function() {
                this.vy += CFG.gravity; this.y += this.vy;
                let groundY = H - CFG.groundH;
                if(this.y + this.h >= groundY) { this.y = groundY - this.h; this.vy = 0; this.grounded = true; } 
                else { this.grounded = false; }
            },
            jump: function() { if(this.grounded) { this.vy = CFG.jumpForce; this.grounded = false; } },
            draw: function() {
                // GET COLORS FROM CURRENT SKIN
                const pal = PALETTES[state.currentFlavor] || PALETTES['orig'];
                
                ctx.fillStyle = pal.body; ctx.fillRect(this.x, this.y, this.w, this.h); 
                // Dynamic Label Color
                ctx.fillStyle = pal.label; ctx.fillRect(this.x, this.y + 25, this.w, 22); 
                // Dynamic Cap Color
                ctx.fillStyle = pal.cap; ctx.fillRect(this.x + 8, this.y - 12, 18, 12); 
            },
            getHitbox: function() { return { x: this.x + 10, y: this.y + 10, w: this.w - 20, h: this.h - 15 }; }
        };

        function resize() {
            scale = window.devicePixelRatio || 1; W = window.innerWidth; H = window.innerHeight;
            cvs.width = W * scale; cvs.height = H * scale; ctx.scale(scale, scale);
            player.x = (W / 2) - (player.w / 2);
        }
        window.addEventListener('resize', resize);
        resize();

        // --- HAMBURG SKYLINE (Industrial Vibe) ---
        let cityOffset1 = 0; let cityOffset2 = 0;
        function drawSkyline(offset, color, heightMod, speedMod) {
            ctx.fillStyle = color; const bw = 40; const count = Math.ceil(W/bw) + 1; const scroll = (offset * speedMod) % bw;
            for(let i=0; i<count; i++) {
                // Procedural industrial shapes (Cranes/Warehouses)
                let seed = Math.sin(i * 132 + heightMod);
                let h = 60 + Math.abs(seed * 120);
                let isCrane = seed > 0.8; 
                let x = (i * bw) - scroll; let y = H - CFG.groundH - h;

                if(isCrane) {
                    // Draw Crane-like structure
                    ctx.fillRect(x + 10, y + 20, 10, h - 20); // Stem
                    ctx.fillRect(x - 20, y + 20, 60, 10); // Arm
                } else {
                    // Warehouse/Building
                    ctx.fillRect(x, y, bw+1, h);
                    // Windows (Club lights)
                    ctx.fillStyle = (i%3===0) ? '#222' : '#111'; 
                    if(i%2 !== 0) {
                         for(let w=0; w<2; w++) { for(let r=0; r<3; r++) { if(Math.random()>0.8) ctx.fillRect(x + 8 + (w*12), y + 20 + (r*20), 4, 4); } }
                    }
                }
                ctx.fillStyle = color; 
            }
        }

        let obstacles = [];
        const words = ["Zzz", "SLEEP", "TIRED", "NAP", "DOZE"];
        function spawnObstacle() {
            obstacles.push({ x: W + 200, y: H - CFG.groundH - 45, w: 60, h: 36, txt: words[Math.floor(Math.random()*words.length)], passed: false });
        }

        // --- LOOP ---
        function loop() {
            if(!state.isPlaying) return;
            ctx.fillStyle = '#080808'; ctx.fillRect(0, 0, W, H);
            
            cityOffset1 += 2; cityOffset2 += CFG.speed;
            drawSkyline(cityOffset1, '#111', 50, 0.5); drawSkyline(cityOffset2, '#1a1a1a', 99, 1);
            ctx.fillStyle = '#fff'; ctx.fillRect(0, H - CFG.groundH, W, 2);

            let safeToSpawn = (Date.now() - state.startTime) > 2000;
            let distanceOK = obstacles.length === 0 || (W - obstacles[obstacles.length-1].x > 350);
            if(safeToSpawn && distanceOK && Math.random() < 0.015) spawnObstacle();

            obstacles.forEach((o, i) => {
                o.x -= CFG.speed;
                ctx.fillStyle = '#FFD700'; ctx.fillRect(o.x, o.y, o.w, o.h);
                ctx.fillStyle = '#000000'; ctx.font = "bold 20px Anton"; ctx.fillText(o.txt, o.x + 5, o.y + 26); 
                const p = player.getHitbox();
                const obsBox = { x: o.x + 5, y: o.y + 5, w: o.w - 10, h: o.h - 10 }; 
                if(p.x < obsBox.x + obsBox.w && p.x + p.w > obsBox.x && p.y < obsBox.y + obsBox.h && p.y + p.h > obsBox.y) gameOver(false);
                if(o.x + o.w < 0) obstacles.splice(i, 1);
                if(!o.passed && o.x + o.w < player.x) { state.score++; o.passed = true; if(state.score >= CFG.target) gameOver(true); }
            });

            player.update(); player.draw();
            ctx.fillStyle = '#fff'; ctx.font = "24px Anton"; ctx.fillText(`${state.score} / ${CFG.target}`, 20, 80); 
            animId = requestAnimationFrame(loop);
        }

        // --- FLOW ---
        function startGame() {
            if(state.lives <= 0) return;
            state.lives--; saveUserState(); updateUI();
            state.isPlaying = true; state.score = 0; state.startTime = Date.now(); 
            obstacles = []; player.y = H - CFG.groundH - player.h; player.vy = 0; player.x = (W / 2) - (player.w / 2);
            showScreen(''); showWarmupHint(); loop();
        }

        function showWarmupHint() {
            const el = document.getElementById('warmup-overlay');
            const iconEl = document.getElementById('hint-icon');
            const txtEl = document.getElementById('hint-text');
            const isTouch = ('ontouchstart' in window) || (navigator.maxTouchPoints > 0);
            if(isTouch) { iconEl.innerHTML = '<div class="tap-anim"></div>'; txtEl.innerText = "TAP TO JUMP"; } 
            else { iconEl.innerHTML = '<div class="key-anim"></div>'; txtEl.innerText = "PRESS SPACE"; }
            el.classList.add('show');
            setTimeout(() => { el.classList.remove('show'); }, 1900);
        }

        function gameOver(win) {
            state.isPlaying = false; cancelAnimationFrame(animId);
            const title = document.getElementById('go-title');
            const msg = document.getElementById('go-msg');
            const boxEmail = document.getElementById('box-email');
            const boxActs = document.getElementById('box-actions');
            const btnRetry = document.getElementById('btn-retry');

            if(win) {
                title.innerText = "AWAKE"; title.style.color = "#fff";
                if(state.email) {
                    msg.innerHTML = `Ticket registered to:<br><span class="red">${state.email}</span>`;
                    boxEmail.classList.add('hidden'); boxActs.classList.remove('hidden');
                } else {
                    msg.innerText = "Threshold Reached. Enter email to claim ticket.";
                    boxEmail.classList.remove('hidden'); boxActs.classList.add('hidden');
                }
            } else {
                title.innerText = "ASLEEP"; title.style.color = "#666";
                msg.innerText = `Score: ${state.score}. Needed: ${CFG.target}`;
                boxEmail.classList.add('hidden'); boxActs.classList.remove('hidden');
            }
            if(state.lives > 0) btnRetry.classList.remove('hidden'); else btnRetry.classList.add('hidden');
            showScreen('s-over');
        }

        function submitEmail() {
            const val = document.getElementById('inp-email').value;
            if(val.includes('@')) {
                state.email = val; saveUserState();
                showModal("TICKET SAVED", "You have been entered into the raffle.");
                document.getElementById('box-email').classList.add('hidden');
                document.getElementById('box-actions').classList.remove('hidden');
            } else { showModal("ERROR", "Please enter a valid email address."); }
        }

        const video = document.getElementById('video');
        async function openCam() {
            showScreen('s-cam');
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } });
                video.srcObject = stream;
                setTimeout(() => redeemSimulator(), 2500);
            } catch(e) { console.log(e); }
        }
        function closeCam() {
            if(video.srcObject) video.srcObject.getTracks().forEach(t=>t.stop());
            updateUI();
        }

        function redeemSimulator() {
            closeCam();
            const randomCode = Math.random().toString(36).substr(2, 6).toUpperCase();
            const qrId = "FK-" + randomCode;

            // DYNAMIC FLAVOR SELECTOR
            const flavors = ['orig', 'sugar', 'misch', 'orange'];
            const found = flavors[Math.floor(Math.random() * flavors.length)];
            const flavNames = { 'orig': 'KOLA', 'sugar': 'SUGAR FREE', 'misch': 'MISCHMASCH', 'orange': 'ORANGE KOLA' };

            const result = db.redeemCode(qrId);
            if (!result.success) { showModal("ERROR", `Code ${qrId} already used!`); return; }

            // UPDATE STATE
            let isNew = !state.collection[found];
            state.collection[found] = true; 
            state.lives++;
            state.currentFlavor = found; // SET ACTIVE SKIN
            saveUserState();

            let msg = `ID: ${qrId}\nFlavor: ${flavNames[found]}\n+1 Life Added.`;
            if(isNew) msg += "\n\nNEW ITEM UNLOCKED!";
            
            showModal("BOTTLE VERIFIED", msg);
            updateUI();
        }

        function showModal(title, msg) {
            document.getElementById('m-title').innerText = title;
            document.getElementById('m-msg').innerText = msg;
            document.getElementById('modal-overlay').classList.add('open');
        }
        window.closeModal = function() { document.getElementById('modal-overlay').classList.remove('open'); }

        function updateUI() {
            document.getElementById('ui-lives').innerText = state.lives;
            const btnP = document.getElementById('btn-play');
            const btnS = document.getElementById('btn-scan');
            const introMsg = document.getElementById('intro-msg');
            
            updateVault();
            const capsFound = Object.values(state.collection).filter(x=>x).length;
            
            if(state.lives > 0) {
                btnP.classList.remove('hidden'); btnS.classList.add('hidden');
                introMsg.innerText = `System Charged. Active Skin: ${state.currentFlavor.toUpperCase()}.`;
                showScreen('s-intro');
            } else {
                btnP.classList.add('hidden'); btnS.classList.remove('hidden');
                introMsg.innerText = `Energy Depleted. Scan a bottle to play.`;
                if(state.screen !== 's-cam') showScreen('s-intro');
            }
        }

        function showScreen(id) {
            state.screen = id;
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            const header = document.getElementById('main-header');
            if(id === 's-cam' || id === 's-over') header.classList.add('fade-out');
            else header.classList.remove('fade-out');
            if(id) document.getElementById(id).classList.add('active');
        }

        function handleJump(e) {
            if(state.isPlaying) { if(e.type === 'touchstart') e.preventDefault(); player.jump(); }
        }
        window.addEventListener('keydown', e => { if(e.code==='Space') handleJump(e); });
        cvs.addEventListener('touchstart', handleJump, {passive: false});
        cvs.addEventListener('mousedown', handleJump);

        document.getElementById('btn-play').onclick = startGame;
        document.getElementById('btn-scan').onclick = openCam;
        document.getElementById('btn-rescan').onclick = openCam;
        document.getElementById('btn-close-cam').onclick = closeCam;
        document.getElementById('btn-retry').onclick = startGame;
        document.getElementById('btn-claim').onclick = submitEmail;
        document.getElementById('dev-tap').onclick = redeemSimulator;

        updateUI();

    </script>
</body>
</html>